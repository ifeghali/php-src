#!/bin/sh
# $Id$

amv=`automake --version | grep GNU |cut -d ' ' -f 4`

if expr $amv '>=' 2.5; then
    echo "cleaning checkout to force rebuild, due to bad AutoMake"
    ./cvsclean
fi


if test -d "Zend"; then
    ZENDVER=`cat Zend/zend.h | grep ZEND_VERSION | cut -d ' ' -f 3 | sed -e 's/"//' | cut -d . -f 1`
fi

while test $# -gt 0; do
    if test "$1" = "--copy"; then
        automake_flags=--copy
    fi

    if test "$1" = "--ZendEngine2"; then
        ZENDDIR=ZendEngine2

	if test $ZENDVER != 2; then
	    mv Zend Zend_old

	    if test -d "ZendEngine2"; then
		mv ZendEngine2 Zend
	    fi	
	fi    
        echo "Using Zend Engine 2 code"
    fi

    if test "$1" = "--Zend"; then
	ZENDDIR=Zend
	
	if test $ZENDVER != 1; then
	    echo "The default Zend directory exists, but it doesn't seem to be Zend Engine 1"
	    exit
	else
	    echo "Using default Zend directory"
	fi	
    fi	

    shift
done

if test -z "$ZENDDIR"; then
    ZENDDIR=Zend
    echo "using default Zend directory"
fi
 
## build.mk does not check aclocal exit status yet
##
#mv aclocal.m4 aclocal.m4.old 2>/dev/null
#aclocal
#if test "$?" != "0" -a "$am_prefix" != "$lt_prefix"; then
#    echo "buildconf: ERROR: aclocal failed, probably because automake and"
#    echo "           libtool are installed with different prefixes;"
#    echo "           automake is installed in $am_prefix, but libtool in $lt_prefix."
#    echo "           Please re-install automake and/or libtool with a common prefix"
#    echo "           and try again."
#    exit 1
#fi

rm -f generated_lists

${MAKE:-make} -s -f build/build.mk AMFLAGS="$automake_flags"
